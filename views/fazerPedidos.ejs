<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fazer Pedidos - Pedido de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="css/style.css" />
    <style>
      * {
        font-family: 'Inter', sans-serif;
      }

      body {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        min-height: 100vh;
      }

      .sidebar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
        min-height: 100vh;
        width: 280px;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 2rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      .sidebar-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #dc2626;
        margin: 0;
      }

      .nav-pills .nav-link {
        color: #4a5568;
        border-radius: 12px;
        margin: 0.25rem 0;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .nav-pills .nav-link:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        transform: translateX(4px);
      }

      .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }

      .nav-pills .nav-link i {
        margin-right: 0.5rem;
        font-size: 1.1rem;
      }

      .main-content {
        margin-left: 280px;
        padding: 2rem;
      }

      .page-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        animation: fadeInDown 0.5s ease;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        margin: 0 0 0.5rem 0;
      }

      .page-subtitle {
        color: #718096;
        margin: 0;
        font-size: 1rem;
      }

      /* Stats Cards */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        animation: fadeInUp 0.5s ease;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .stat-icon.red {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
      }

      .stat-icon.blue {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #2563eb;
      }

      .stat-icon.green {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #059669;
      }

      .stat-icon.yellow {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #d97706;
      }

      .stat-label {
        font-size: 0.875rem;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
      }

      .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #2d3748;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .btn-action-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
      }

      .btn-action-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }

      .btn-action-modern i {
        font-size: 1.1rem;
      }

      .table-container {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
        animation: fadeInUp 0.6s ease;
      }

      .table-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f7fafc;
      }

      .table-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
      }

      .table-actions {
        display: flex;
        gap: 0.75rem;
      }

      .btn-table-action {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-table-action:hover {
        transform: translateY(-1px);
      }

      .btn-primary-custom {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .btn-success-custom {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .btn-info-custom {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .btn-warning-custom {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
      }

      /* Table Enhancements */
      .table {
        margin-bottom: 0;
      }

      .table thead {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      }

      .table thead th {
        border-bottom: 2px solid #fecaca;
        color: #991b1b;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding: 1rem 0.5rem;
      }

      .table tbody tr {
        transition: all 0.2s ease;
      }

      .table tbody tr:hover {
        background: #fef2f2;
      }

      .header_table {
        font-size: 8px;
        align-items: center;
        justify-content: center;
      }

      table tbody td {
        padding: 0.5rem;
        font-size: 8px;
        /* Ajuste o tamanho da fonte */
        line-height: 5px;
        /* Reduz a altura da linha */
        vertical-align: middle;
        /* Centraliza os dados no meio da célula */
        text-align: center;
        /* Centraliza horizontalmente (opcional) */
      }

      .table td {
        padding: 1px;
      }

      .btn-custom {
        padding: 0.25rem 0.5rem;
        /* Reduz o padding */
        font-size: 0.875rem;
        /* Reduz o tamanho da fonte */
        line-height: 1.5;
        /* Ajusta a altura da linha */
      }

      .btn-container {
        margin: 0;
        /* Remove margens */
        padding: 0;
        /* Remove paddings */
      }

      table {
        td:nth-child(3) {
          width: 10%;
        }

        td:nth-child(5) {
          width: 5%;
        }

        td:nth-child(5) {
          width: 40%;
        }

        td:nth-child(6) {
          width: 5%;
          font-size: 10px;
        }

        td:nth-child(7) {
          width: 5%;
          font-size: 10px;
        }

        td:nth-child(8) {
          width: 5%;
          font-size: 10px;
          text-align: center;
        }

        td:nth-child(9) {
          background-color: #ffff00;
          font-weight: bold;
          font-size: 10px;
          text-align: center;
        }

        td:nth-child(10) {
          background-color: #008080;
          font-weight: bold;
          font-size: 10px;
          text-align: center;
        }

        td:nth-child(11) {
          background-color: #00adad;
          font-weight: bold;
          font-size: 10px;
          text-align: center;
        }

        td:nth-child(12) {
          background-color: #00ccff;
          font-weight: bold;
          font-size: 10px;
          text-align: center;
        }

        td:nth-child(13) {
          width: 7%;
        }

        td:nth-child(14) {
          width: 10%;
        }
      }

      .f_size {
        font-size: 8pt;
        width: 100%;
        margin: 0;
      }

      .input-pequeno {
        font-size: 10px;
        /* Ajuste conforme necessário */
        text-align: center;
        /* Para alinhar os números */
        height: 100%;
        /* Garante que o input não cresça além da célula */
        padding: 1px;
        /* Reduz espaço interno */
      }

      .filter-row {
        background-color: #f8f9fa;
      }

      .filter-row th {
        padding: 2px !important;
      }

      .filter-input {
        font-size: 12px !important;
        height: 24px !important;
        padding: 0.15rem 0.3rem !important;
      }

      /* Menu de filtro suspenso */
      .filter-menu {
        position: absolute;
        background: white;
        border: 3px solid #ddd;
        padding: 5px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        max-height: 300px;
        overflow-y: auto;
      }

      .filter-menu-item {
        padding: 3px 5px;
        cursor: pointer;
        white-space: nowrap;
      }

      .filter-menu-item:hover {
        background-color: #f0f0f0;
      }

      .filter-menu input[type="text"] {
        width: 100%;
        margin-bottom: 5px;
        padding: 2px;
      }

      .filter-menu .filter-actions {
        margin-top: 5px;
        padding-top: 5px;
      }

      table thead tr:first-child {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
      }

      table thead tr.filter-row {
        position: sticky;
        top: 30px; /* Altura da linha do cabeçalho */
        background-color: #f8f9fa;
        z-index: 10;
      }
      /* Estilos para ordenação com ícones */
      .sort-icons {
        display: inline-flex;
        flex-direction: linear;
        margin-left: 5px;
        vertical-align: middle;
      }

      .sort-icons i {
        font-size: 10px;

        cursor: pointer;
        color: #aaa;
        transition: all 0.2s;
      }

      .sort-icons i:hover {
        color: #555;
      }

      .sort-icons .active {
        color: #0d6efd;
        text-shadow: 0 0 2px rgba(13, 110, 253, 0.5);
      }

      /* Adicione ao seu CSS existente */
      .sort-icons i.active {
        color: #0d6efd;
        text-shadow: 0 0 2px rgba(13, 110, 253, 0.5);
        font-weight: bold;
      }

      .sort-icons i:not(.active) {
        opacity: 0.5;
        transition: opacity 0.2s;
      }

      .sort-icons:hover i:not(.active) {
        opacity: 0.8;
      }

      /* Floating Buttons */
      .floating-buttons-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
      }

      .btn-floating {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #500001;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transition: transform 0.2s, background-color 0.2s;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
      }

      .btn-floating:hover {
        transform: scale(1.1);
        background-color: #7a0002;
        color: white;
      }

      .btn-logout {
        background-color: #d33;
      }

      .btn-logout:hover {
        background-color: #ff4d4d;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-title">
          <i class="bi bi-cart-check"></i> Pedidos de Compras
        </h1>
      </div>
      <div class="p-3">
        <ul class="nav nav-pills flex-column">
          <li class="nav-item">
            <a href="/pedidosCompras" class="nav-link">
              <i class="bi bi-plus-circle"></i>
              Criar Pedidos
            </a>
          </li>
          <li class="nav-item">
            <a href="/listaPedidos" class="nav-link">
              <i class="bi bi-list-ul"></i>
              Lista de Pedidos
            </a>
          </li>
          <li class="nav-item">
            <a href="/fazerPedidos" class="nav-link active">
              <i class="bi bi-clipboard-check"></i>
              Fazer Pedidos
            </a>
          </li>
          <li class="nav-item">
            <a href="/finalizarPedidos" class="nav-link">
              <i class="bi bi-check-circle"></i>
              Finalizar Pedidos
            </a>
          </li>
          <li class="nav-item">
            <a href="/pedidosFinalizados" class="nav-link">
              <i class="bi bi-archive"></i>
              Pedidos Finalizados
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">Fazer Pedidos</h1>
        <p class="page-subtitle">Analise produtos e defina quantidades para o pedido</p>
      </div>

      <!-- Table Container -->
      <div class="table-container">
        <table class="table">
          <thead class="header_table">
            <tr>
              <th scope="col">
                LINHA
                <div class="sort-icons">
                  <i class="bi bi-sort-alpha-up sort-asc" data-col="0"></i>
                  <i class="bi bi-sort-alpha-down sort-desc" data-col="0"></i>
                </div>
              </th>
              <th scope="col">
                COD JIVA
                <div class="sort-icons">
                  <i class="bi bi-sort-alpha-up sort-asc" data-col="1"></i>
                  <i class="bi bi-sort-alpha-down sort-desc" data-col="1"></i>
                </div>
            </th>
            <th scope="col">
              COD BARRA
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="2"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="2"></i>
              </div>
            </th>
            <th scope="col">
              REF
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="3"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="3"></i>
              </div>
            </th>
            <th scope="col">
              PRODUTO
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="4"></i>

                <i class="bi bi-sort-alpha-down sort-desc" data-col="4"></i>
              </div>
            </th>
            <th scope="col">
              VLR VENDA
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="5"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="5"></i>
              </div>
            </th>
            <th scope="col">
              ULT CUS
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="6"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="6"></i>
              </div>
            </th>
            <th scope="col">
              ULT COMPRA
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="7"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="7"></i>
              </div>
            </th>
            <th scope="col">
              COMPRA TT
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="8"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="8"></i>
              </div>
            </th>
            <th scope="col">
              VENDA TT
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="9"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="9"></i>
              </div>
            </th>
            <th scope="col">
              MED VENDA
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="10"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="10"></i>
              </div>
            </th>
            <th scope="col">
              EST
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="11"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="11"></i>
              </div>
            </th>
            <th scope="col">
              QTD PEDIDO
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="12"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="12"></i>
              </div>
            </th>
            <th scope="col">
              VLR PEDIDO
              <div class="sort-icons">
                <i class="bi bi-sort-alpha-up sort-asc" data-col="13"></i>
                <i class="bi bi-sort-alpha-down sort-desc" data-col="13"></i>
              </div>
            </th>
          </tr>
          <tr class="filter-row">
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="0"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="1"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="2"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="3"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="4"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="5"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="6"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="7"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="8"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="9"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="10"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="11"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="12"
              />
            </th>
            <th>
              <input
                type="text"
                class="form-control form-control-sm filter-input"
                data-col="13"
              />
            </th>
          </tr>
        </thead>
        <tbody class="table_data">
          <tr></tr>
        </tbody>
      </table>
      <div class="container mt-3">
        <div class="d-flex justify-content-start gap-1">
          <div class="btn-container">
            <button
              type="button"
              class="btn btn-primary btn-custom"
              id="btn-finalizar"
            >
              Finalizar
            </button>
            <div class="dropdown d-inline-block">
              <button
                class="btn btn-success btn-custom dropdown-toggle"
                type="button"
                id="exportarDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Exportar
              </button>
              <ul class="dropdown-menu" aria-labelledby="exportarDropdown">
                <li><a class="dropdown-item" id="btn-exportar-pdf">PDF</a></li>
                <li>
                  <a class="dropdown-item" id="btn-exportar-excel">Excel</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="ms-auto p-2">
            <div class="dropdown me-1">
              <button
                type="button"
                class="btn btn-secondary dropdown-toggle"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                data-bs-offset="10,20"
                id="empresa"
              >
                Empresa
              </button>
              <ul class="dropdown-menu" aria-labelledby="empresa">
                <li>
                  <a class="dropdown-item emp" value="1">1 - EXCLUSIVA</a>
                </li>
                <li><a class="dropdown-item emp" value="2">2 - SG</a></li>
                <li><a class="dropdown-item emp" value="3">3 - UTIL</a></li>
                <li><a class="dropdown-item emp" value="4">4 - 85</a></li>
                <li><a class="dropdown-item emp" value="5">5 - SITE</a></li>
                <li><a class="dropdown-item emp" value="6">6 - DECORA</a></li>
                <li><a class="dropdown-item emp" value="7">7 - ASG</a></li>
              </ul>
              <div class="form-group">
                <label for="dtFat">Data Faturamento</label>
                <input
                  type="date"
                  class="form-control"
                  id="dtFat"
                  placeholder="Data inicial"
                />
              </div>
              <div class="form-group">
                <label for="dtEntrega">Data Entrega</label>
                <input
                  type="date"
                  class="form-control"
                  id="dtEntrega"
                  placeholder="Data Final"
                />
              </div>
            </div>
          </div>
          <div class="ms-auto p-2">
            <Span id="valorTotal">Valor Total : </Span>
          </div>
        </div>
      </div>
    </div>
    <!-- End Table Container -->
    </div>
    <!-- End Main Content -->

    <!-- Modals removed - now using SweetAlert2 for all notifications -->

    <!-- Floating Buttons -->
    <div class="floating-buttons-container">
      <a href="/" class="btn-floating" title="Voltar ao Menu">
        <i class="fas fa-home"></i>
      </a>
      <button id="logoutBtn" class="btn-floating btn-logout" title="Sair">
      </button>
    </div>

    <form id="logoutForm" action="/logout" method="POST" style="display: none;"></form>
  </body>
  
  <!-- ExcelJS for beautiful Excel exports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <!-- FileSaver for saving files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let somaTotal = 0;
    const apiBase = `${window.location.protocol}//${window.location.hostname}:3000`;
    let pedidosAtualizados = []; // Variável global para armazenar os dados
    let codemp;
    const timeElapsed = Date.now();
    const dataPedido = new Date(timeElapsed).toLocaleString();
    let marca_pedido;

    // Função para carregar os dados do pedido
    async function carregarDadosPedido(id_pedido) {
      try {
        const apiUrl = `${apiBase}/loadPedidos?id_pedido=${id_pedido}`;
        console.log("URL da API:", apiUrl); // Log para depuração

        const response = await fetch(apiUrl, {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        });

        if (!response.ok) {
          throw new Error(`Erro na requisição: ${response.statusText}`);
        }

        const pedidoCompra = await response.json();
        console.log("Dados recebidos:", pedidoCompra); // Log para depuração

        if (!Array.isArray(pedidoCompra)) {
          throw new Error("Dados recebidos não são um array.");
        }

        const tabelaBody = document.querySelector("table tbody");
        tabelaBody.innerHTML = "";
        pedidosAtualizados = []; // Resetar os pedidos armazenados
        somaTotal = 0; // Resetar soma total

        pedidoCompra.forEach((pedido) => {
          // Converter valores vindos do banco
          const qtdInicial = parseFloat(pedido.QTD_PEDIR) || 0;
          const vlrTotalInicial = parseFloat(pedido.VLR_TOTAL) || 0;
          
          // Adicionar ao array de controle com os valores existentes
          pedidosAtualizados.push({
            id: id_pedido,
            codProd: pedido.CODPROD,
            quantidade: qtdInicial,
            valorTotal: vlrTotalInicial.toFixed(2),
          });

          // Somar ao total geral
          somaTotal += vlrTotalInicial;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${pedido.LINHA || ""}</td>
            <td>${pedido.CODPROD || ""}</td>
            <td>${pedido.REFERENCIA || ""}</td>
            <td>${pedido.REFFORN || ""}</td>
            <td>${pedido.DESCRPROD || ""}</td>
            <td>R$${(pedido.VLR_VENDA || 0).toFixed(2)}</td>
            <td>R$${(pedido.ENTRADACOMICMS || 0).toFixed(2)}</td>
            <td>${pedido.QTDULTIMA_COMPA || ""}</td>
            <td>${pedido.COMP_QTD || 0}</td>
            <td>${pedido.VNDS_QTD || 0}</td>
            <td>${(pedido.MED_VENDA || 0).toFixed(2)}</td>
            <td>${pedido.ESTOQUE || 0}</td>
            <td>
              <input type="number" class="f_size input-pequeno" data-id="${
                pedido.CODPROD
              }" data-preco="${(pedido.ENTRADACOMICMS || 0).toFixed(
            2
          )}" value="${qtdInicial > 0 ? qtdInicial : ""}">
            </td>
            <td class="total">R$ ${(vlrTotalInicial || 0).toFixed(2)}</td>
          `;
          tabelaBody.appendChild(row);
        });

        // Atualizar o display do valor total na tela
        const totalPedidoElement = document.getElementById("valorTotal");
        if (totalPedidoElement) {
            totalPedidoElement.innerHTML = `Valor Total: R$ ${somaTotal.toFixed(2)}`;
        }

      } catch (error) {
        console.error("Erro ao carregar Pedidos:", error.message);
      }
    }

    // Captura o id_pedido da URL e carrega os dados
    const urlParams = new URLSearchParams(window.location.search);
    const id_pedido = urlParams.get("id_pedido"); // Captura o id_pedido da URL

    if (id_pedido) {
      carregarDadosPedido(id_pedido);
    } else {
      console.error("ID do pedido não encontrado na URL.");
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Configuração do dropdown Empresa
      const empresaDropdownButton = document.getElementById("empresa");
      const empresaDropdownItems = document.querySelectorAll(
        ".dropdown-menu[aria-labelledby='empresa'] .dropdown-item"
      );

      // Evento para atualizar ao clicar no dropdown Empresa
      empresaDropdownItems.forEach((item) => {
        item.addEventListener("click", function (event) {
          event.stopPropagation(); // Impede propagação do evento
          codemp = this.getAttribute("value");
          empresaDropdownButton.textContent = this.textContent;
          console.log("Codigo Empresa:", codemp);
        });
      });

      // Exemplo: Selecionar automaticamente a opção "3 - UTIL" ao carregar a página
    });
    function validarEFormatarPedidos(pedidos) {
      return pedidos
        .filter((pedido) => {
          // Filtra pedidos com quantidade válida > 0
          const qtd = Number(pedido.quantidade);
          return !isNaN(qtd) && qtd > 0;
        })
        .map((pedido) => {
          // Formatação consistente dos dados
          return {
            id: Number(pedido.id),
            codProd: Number(pedido.codProd), // Garante que é string
            quantidade: Number(pedido.quantidade),
            valorTotal: Number(pedido.valorTotal || 0),
          };
        });
    }

    function prepararPedidosParaEnvio(pedidos) {
      return pedidos
        .filter((pedido) => {
          // Filtra pedidos com quantidade válida > 0
          const qtd = Number(pedido.quantidade);
          return !isNaN(qtd) && qtd > 0;
        })
        .map((pedido) => {
          // Conversão explícita de tipos
          return {
            id: Number(pedido.id),
            codProd: Number(pedido.codProd), // Garante que é número
            quantidade: Number(pedido.quantidade),
            valorTotal: Number(pedido.valorTotal || 0),
          };
        });
    }

    // Atualizar dados ao alterar as quantidades
    document.addEventListener("input", (event) => {
      if (event.target.matches("input[data-id]")) {
        const input = event.target;
        const row = input.closest("tr");
        const totalPedido = document.getElementById("valorTotal");
        const precoUnitario = parseFloat(input.dataset.preco) || 0;
        const quantidade = parseFloat(input.value) || 0;
        const total = precoUnitario * quantidade;

        row.querySelector(".total").textContent = `R$ ${total.toFixed(2)}`;

        const idProduto = input.dataset.id;
        const pedido = pedidosAtualizados.find((p) => p.codProd == idProduto);
        if (pedido) {
          pedido.quantidade = quantidade;
          pedido.valorTotal = total.toFixed(2);
        }

        // Calcula o total geral de todos os pedidos
        somaTotal = pedidosAtualizados.reduce(
          (acc, p) => Number(acc) + Number(p.valorTotal),
          0
        );
      }
    });

    function applyFilters() {
      const rows = document.querySelectorAll("table tbody tr");
      let hasVisibleRows = false;

      rows.forEach((row) => {
        let shouldShow = true;
        const cells = row.cells;

        for (const [colIndex, filterValue] of Object.entries(activeFilters)) {
          if (filterValue) {
            let cellValue;

            if (colIndex == 12) {
              // Coluna QTD PEDIDO (input)
              cellValue = cells[colIndex]
                .querySelector("input")
                .value.trim()
                .toLowerCase();
            } else {
              cellValue = cells[colIndex].textContent.trim().toLowerCase();
            }

            if (!cellValue.includes(filterValue.toLowerCase())) {
              shouldShow = false;
              break;
            }
          }
        }

        row.style.display = shouldShow ? "" : "none";
        if (shouldShow) hasVisibleRows = true;
      });

      return hasVisibleRows;
    }

    // Event listener para os inputs de filtro
    document.querySelectorAll(".filter-input").forEach((input) => {
      input.addEventListener("input", function () {
        const colIndex = this.getAttribute("data-col");

        if (this.value.trim() === "") {
          delete activeFilters[colIndex];
        } else {
          activeFilters[colIndex] = this.value.trim();
        }

        applyFilters();
      });
    });

    // Função para mostrar o menu de filtro avançado
    function showFilterMenu(columnIndex, button) {
      // Remove qualquer menu existente
      const existingMenu = document.querySelector(".filter-menu");
      if (existingMenu) existingMenu.remove();

      // Cria o novo menu
      const menu = document.createElement("div");
      menu.className = "filter-menu";

      // Posiciona o menu abaixo do botão
      const rect = button.getBoundingClientRect();
      menu.style.left = `${rect.left}px`;
      menu.style.top = `${rect.bottom}px`;

      // Adiciona campo de busca
      menu.innerHTML = `
    <input type="text" placeholder="Filtrar..." class="form-control form-control-sm" id="filter-search">
    <div id="filter-options"></div>
    <div class="filter-actions">
      <button class="btn btn-sm btn-primary" id="apply-filter">Aplicar</button>
      <button class="btn btn-sm btn-secondary" id="clear-filter">Limpar</button>
    </div>
  `;

      document.body.appendChild(menu);

      // Coleta valores únicos da coluna
      const columnValues = new Set();
      document
        .querySelectorAll(
          `table tbody tr td:nth-child(${parseInt(columnIndex) + 1})`
        )
        .forEach((td) => {
          columnValues.add(td.textContent.trim());
        });

      // Ordena os valores
      const sortedValues = Array.from(columnValues).sort();

      // Adiciona opções ao menu
      const optionsContainer = menu.querySelector("#filter-options");
      sortedValues.forEach((value) => {
        if (value) {
          const option = document.createElement("div");
          option.className = "filter-menu-item";
          option.textContent = value;
          option.addEventListener("click", () => {
            const searchInput = menu.querySelector("#filter-search");
            searchInput.value = value;
          });
          optionsContainer.appendChild(option);
        }
      });

      // Filtra as opções conforme digita
      menu
        .querySelector("#filter-search")
        .addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          Array.from(optionsContainer.children).forEach((option) => {
            option.style.display = option.textContent
              .toLowerCase()
              .includes(searchTerm)
              ? ""
              : "none";
          });
        });

      // Aplica o filtro
      menu.querySelector("#apply-filter").addEventListener("click", () => {
        const filterValue = menu.querySelector("#filter-search").value.trim();
        const filterInput = document.querySelector(
          `.filter-input[data-col="${columnIndex}"]`
        );
        filterInput.value = filterValue;
        activeFilters[columnIndex] = filterValue;
        applyFilters();
        menu.remove();
      });

      // Limpa o filtro
      menu.querySelector("#clear-filter").addEventListener("click", () => {
        const filterInput = document.querySelector(
          `.filter-input[data-col="${columnIndex}"]`
        );
        filterInput.value = "";
        delete activeFilters[columnIndex];
        applyFilters();
        menu.remove();
      });

      // Fecha o menu ao clicar fora
      document.addEventListener("click", function closeMenu(e) {
        if (!menu.contains(e.target) && e.target !== button) {
          menu.remove();
          document.removeEventListener("click", closeMenu);
        }
      });
    }

    // Event listeners para os botões de filtro
    document.querySelectorAll(".btn-filter").forEach((button) => {
      button.addEventListener("click", function (e) {
        e.stopPropagation();
        const colIndex = this.getAttribute("data-col");
        showFilterMenu(colIndex, this);
      });
    });

    // Fechar menu ao rolar
    window.addEventListener("scroll", function () {
      const menu = document.querySelector(".filter-menu");
      if (menu) menu.remove();
    });
    // Variáveis para controle de ordenação
    let currentSortColumn = null;
    let isAscending = true;

    // Função para ordenar a tabela
    function sortTable(columnIndex, ascending) {
      const table = document.querySelector("table");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      // Remove todas as classes ativas primeiro
      document.querySelectorAll(".sort-icons i").forEach((icon) => {
        icon.classList.remove("active");
      });

      // Ativa apenas o ícone correspondente
      const directionClass = ascending ? "sort-asc" : "sort-desc";
      const activeIcon = document.querySelector(
        `.${directionClass}[data-col="${columnIndex}"]`
      );
      if (activeIcon) {
        activeIcon.classList.add("active");
      }

      // Ordena as linhas
      rows.sort((rowA, rowB) => {
        const cellA = rowA.cells[columnIndex];
        const cellB = rowB.cells[columnIndex];

        let valueA, valueB;

        // Tratamento especial para colunas numéricas
        if ([5, 6, 8, 9, 10, 11, 12, 13].includes(columnIndex)) {
          // Para colunas de valores (VLR VENDA, ULT CUS, etc.)
          valueA =
            parseFloat(
              cellA.textContent.replace("R$", "").replace(",", "").trim()
            ) || 0;
          valueB =
            parseFloat(
              cellB.textContent.replace("R$", "").replace(",", "").trim()
            ) || 0;
        } else if (columnIndex === 12) {
          // Para coluna QTD PEDIDO (input)
          valueA = parseFloat(cellA.querySelector("input").value) || 0;
          valueB = parseFloat(cellB.querySelector("input").value) || 0;
        } else {
          // Para colunas de texto
          valueA = cellA.textContent.trim().toLowerCase();
          valueB = cellB.textContent.trim().toLowerCase();
        }

        if (valueA < valueB) return ascending ? -1 : 1;
        if (valueA > valueB) return ascending ? 1 : -1;
        return 0;
      });

      // Reinsere as linhas ordenadas
      rows.forEach((row) => tbody.appendChild(row));

      // Atualiza estado atual
      currentSortColumn = columnIndex;
      isAscending = ascending;
    }

    // Event listeners para os ícones de ordenação
    document.querySelectorAll(".sort-asc").forEach((icon) => {
      icon.addEventListener("click", function () {
        const columnIndex = parseInt(this.getAttribute("data-col"));
        // Se já estiver ordenado ascendente, desativa a ordenação
        if (currentSortColumn === columnIndex && isAscending) {
          sortTable(columnIndex, true); // Isso removerá todas as classes ativas
          currentSortColumn = null; // Reseta o estado
        } else {
          sortTable(columnIndex, true);
        }
      });
    });

    document.querySelectorAll(".sort-desc").forEach((icon) => {
      icon.addEventListener("click", function () {
        const columnIndex = parseInt(this.getAttribute("data-col"));
        // Se já estiver ordenado descendente, desativa a ordenação
        if (currentSortColumn === columnIndex && !isAscending) {
          sortTable(columnIndex, false); // Isso removerá todas as classes ativas
          currentSortColumn = null; // Reseta o estado
        } else {
          sortTable(columnIndex, false);
        }
      });
    });

    // Função para combinar filtros e ordenação
    function applyFiltersAndSort() {
      applyFilters(); // Aplica os filtros primeiro
      if (currentSortColumn !== null) {
        sortTable(currentSortColumn, isAscending); // Mantém a ordenação
      }
    }

    // Atualize o event listener dos filtros para usar a nova função
    document.querySelectorAll(".filter-input").forEach((input) => {
      input.addEventListener("input", function () {
        const colIndex = this.getAttribute("data-col");

        if (this.value.trim() === "") {
          delete activeFilters[colIndex];
        } else {
          activeFilters[colIndex] = this.value.trim();
        }

        applyFiltersAndSort(); // Agora aplica filtros e mantém ordenação
      });
    });

    // Event Listeners para Exportação
    document.addEventListener("DOMContentLoaded", function () {
      // Evento para exportar PDF
      const btnPdf = document.getElementById("btn-exportar-pdf");
      if (btnPdf) {
        btnPdf.addEventListener("click", async function () {
          const btn = this;
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Gerando PDF...';

            await exportarPDF();
            mostrarModal("PDF gerado com sucesso!", "success");
          } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            mostrarModal(`Erro ao gerar PDF: ${error.message}`, "error");
          } finally {
            btn.disabled = false;
            btn.textContent = "PDF";
          }
        });
      }

      // Evento para exportar Excel
      const btnExcel = document.getElementById("btn-exportar-excel");
      if (btnExcel) {
        btnExcel.addEventListener("click", async function () {
          const btn = this;
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Gerando Excel...';

            await exportarExcel();
            mostrarModal("Excel gerado com sucesso!", "success");
          } catch (error) {
            console.error("Erro ao gerar Excel:", error);
            mostrarModal(`Erro ao gerar Excel: ${error.message}`, "error");
          } finally {
            btn.disabled = false;
            btn.textContent = "Excel";
          }
        });
      }
    });

    // Modern modal function using SweetAlert2
    function mostrarModal(mensagem, tipo) {
      const config = {
        title: tipo === 'success' ? 'Sucesso!' : 'Erro!',
        text: mensagem,
        icon: tipo === 'success' ? 'success' : 'error',
        confirmButtonText: 'OK',
        confirmButtonColor: tipo === 'success' ? '#28a745' : '#dc3545',
        timer: tipo === 'success' ? 3000 : undefined,
        showConfirmButton: true
      };

      Swal.fire(config);
    }

    // Evento de clique do botão "Finalizar"
    const btnFinalizar = document.getElementById("btn-finalizar");
    if (btnFinalizar) {
      btnFinalizar.addEventListener("click", async function () {
        if (!id_pedido || !codemp) {
          mostrarModal("Erro: Alguma Informação não foi preenchida.", "error");
          return;
        }

        // Validar e formatar os dados dos pedidos
        const dadosParaEnvio = prepararPedidosParaEnvio(pedidosAtualizados);

        if (dadosParaEnvio.length === 0) {
          mostrarModal("Erro: Nenhum pedido válido para finalizar", "error");
          return;
        }

        console.log("Dados antes de finalizar:", dadosParaEnvio);

        try {
          // 1. Salvar os itens do pedido
          const responseSalvar = await fetch(`${apiBase}/salvarPedidos`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dadosParaEnvio),
          });

          if (!responseSalvar.ok) {
            const errorData = await responseSalvar.json();
            throw new Error(errorData.error || "Erro ao salvar itens do pedido");
          }

          // 2. Atualizar o cabeçalho do pedido (Status FEITO, Empresa, Datas, Total)
          const dadosCabecalho = {
            id: parseInt(id_pedido, 10),
            CodEmp: parseInt(codemp, 10),
            dataFaturamento: document.getElementById("dtFat").value,
            dataEntrega: document.getElementById("dtEntrega").value,
            valorTotal: somaTotal
          };

          const responseAtualizar = await fetch(`${apiBase}/atualizarPedidoFeito`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dadosCabecalho),
          });

          if (!responseAtualizar.ok) {
            const errorData = await responseAtualizar.json();
            throw new Error(errorData.error || "Erro ao atualizar status do pedido");
          }

          const result = await responseAtualizar.json();
          console.log("Pedido finalizado com sucesso:", result);
          
          // 3. Atualizar planilha
          if (typeof atualizaPlanilhaPedidos === 'function') {
             await atualizaPlanilhaPedidos();
          }

          // Exibe modal de sucesso
          mostrarModal("Pedido finalizado com sucesso!", "success");
        } catch (error) {
          console.error("Erro ao finalizar pedido:", error.message);
          mostrarModal(`Erro ao finalizar pedido: ${error.message}`, "error");
        }
      });
    }

    // Função para gerar o PDF (Premium Version)
    async function exportarPDF() {
      return new Promise(async (resolve, reject) => {
        try {
          if (!id_pedido) throw new Error("ID do pedido não encontrado");

          // Obter dados da API
          const response = await fetch(`${apiBase}/exportarPdf?numero_pedido=${id_pedido}`);
          if (!response.ok) throw new Error("Erro ao buscar dados do pedido");
          
          const dadosPedido = await response.json();
          if (!dadosPedido || dadosPedido.length === 0) throw new Error("Nenhum item encontrado");

          // Configurar Empresa
          let empresaNome = "Empresa Desconhecida";
          let cnpj = "";
          const codEmpresa = parseInt(codemp || dadosPedido[0].CODEMP || 0);
          
          switch (codEmpresa) {
            case 1: empresaNome = "Exclusiva Utilidades e Embalagens LTDA"; cnpj = "04.023.539/0001-17"; break;
            case 2: empresaNome = "SG Utilidades"; cnpj = "02.444.585/0001-64"; break;
            case 3: empresaNome = "Exclusiva Util Equipamentos LTDA"; cnpj = "09.666.638/0001-30"; break;
            case 4: empresaNome = "Exclusiva Prime 85 LTDA"; cnpj = "21.518.354/0001-00"; break;
            case 5: empresaNome = "Seg Center Comercial LTDA"; cnpj = "24.486.321/0002-97"; break;
            case 6: empresaNome = "Seg Center Comercial LTDA"; cnpj = "24.486.321/0001-06"; break;
            case 7: empresaNome = "Asg Distribuição LTDA"; cnpj = "49.318.824/0001-01"; break;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Adicionar Logo (se existir)
          const img = new Image();
          img.src = "/images/logo.png";
          
          img.onload = () => {
            doc.addImage(img, "PNG", 14, 10, 60, 15);
            gerarConteudoPDF(doc, empresaNome, cnpj, dadosPedido, resolve);
          };
          
          img.onerror = () => {
            // Se não carregar logo, gera sem logo
            gerarConteudoPDF(doc, empresaNome, cnpj, dadosPedido, resolve);
          };

        } catch (error) {
          reject(error);
        }
      });
    }

    function gerarConteudoPDF(doc, empresaNome, cnpj, dadosPedido, resolve) {
      // Cabeçalho
      doc.setFontSize(18);
      doc.setTextColor(80, 0, 1); // Bordô
      doc.text("PEDIDO DE COMPRA", 195, 20, { align: "right" });
      
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Nº Pedido: ${id_pedido}`, 195, 28, { align: "right" });
      doc.text(`Data: ${new Date().toLocaleDateString()}`, 195, 33, { align: "right" });

      // Info Empresa
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text(empresaNome, 14, 35);
      doc.setFontSize(9);
      doc.setTextColor(100);
      doc.text(`CNPJ: ${cnpj}`, 14, 40);

      // Tabela
      const colunas = ["REF", "PRODUTO", "QTD"];
      const linhas = dadosPedido
        .filter(item => parseFloat(item.QTD_PEDIR) > 0)
        .map(item => [
          item.REFFORN || item.REFERENCIA,
          item.DESCRPROD,
          item.QTD_PEDIR
        ]);

      doc.autoTable({
        startY: 50,
        head: [colunas],
        body: linhas,
        theme: 'grid',
        headStyles: {
          fillColor: [80, 0, 1], // Bordô
          textColor: 255,
          fontSize: 10,
          fontStyle: 'bold'
        },
        bodyStyles: {
          fontSize: 9,
          textColor: 50
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        columnStyles: {
          0: { cellWidth: 40 },
          1: { cellWidth: 'auto' },
          2: { cellWidth: 20, halign: 'center' }
        },
        margin: { top: 50 }
      });

      // Rodapé
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Página ${i} de ${pageCount}`, 195, 290, { align: "right" });
        doc.text(`Gerado em ${new Date().toLocaleString()}`, 14, 290, { align: "left" });
      }

      doc.save(`Pedido_${id_pedido}_${empresaNome.split(' ')[0]}.pdf`);
      resolve();
    }

    // Função para gerar Excel (Premium Version com ExcelJS)
    async function exportarExcel() {
      if (!id_pedido) throw new Error("ID do pedido não encontrado");

      // Obter dados da API (mesma lógica do PDF para garantir dados atualizados)
      const response = await fetch(`${apiBase}/exportarPdf?numero_pedido=${id_pedido}`);
      if (!response.ok) throw new Error("Erro ao buscar dados");
      const dadosPedido = await response.json();
      
      // Configurar Empresa
      let empresaNome = "Empresa Desconhecida";
      const codEmpresa = parseInt(codemp || dadosPedido[0].CODEMP || 0);
      switch (codEmpresa) {
        case 1: empresaNome = "Exclusiva Utilidades"; break;
        case 2: empresaNome = "SG Utilidades"; break;
        case 3: empresaNome = "Exclusiva Util Equipamentos"; break;
        case 4: empresaNome = "Exclusiva Prime 85"; break;
        case 5: empresaNome = "Seg Center Comercial"; break;
        case 6: empresaNome = "Seg Center Comercial"; break;
        case 7: empresaNome = "Asg Distribuição"; break;
      }

      // Criar Workbook
      const workbook = new ExcelJS.Workbook();
      const worksheet = workbook.addWorksheet('Pedido de Compra');

      // Estilos
      const headerStyle = {
        font: { name: 'Arial', size: 16, bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF500001' } }, // Bordô
        alignment: { horizontal: 'center', vertical: 'middle' }
      };

      const subHeaderStyle = {
        font: { name: 'Arial', size: 11, bold: true },
        alignment: { horizontal: 'left' }
      };

      const tableHeaderStyle = {
        font: { name: 'Arial', size: 10, bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF800000' } }, // Vermelho escuro
        alignment: { horizontal: 'center' },
        border: { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }
      };

      // Cabeçalho Principal
      worksheet.mergeCells('A1:C2');
      const titleCell = worksheet.getCell('A1');
      titleCell.value = 'PEDIDO DE COMPRA';
      titleCell.style = headerStyle;

      // Informações
      worksheet.mergeCells('A4:C4');
      worksheet.getCell('A4').value = `Empresa: ${empresaNome}`;
      worksheet.getCell('A4').style = subHeaderStyle;

      worksheet.mergeCells('A5:C5');
      worksheet.getCell('A5').value = `Nº Pedido: ${id_pedido} | Data: ${new Date().toLocaleDateString()}`;
      worksheet.getCell('A5').style = subHeaderStyle;

      // Cabeçalho da Tabela
      worksheet.getRow(7).values = ['REFERÊNCIA', 'PRODUTO', 'QUANTIDADE'];
      ['A7', 'B7', 'C7'].forEach(cell => {
        worksheet.getCell(cell).style = tableHeaderStyle;
      });

      // Dados
      let currentRow = 8;
      dadosPedido.forEach(item => {
        if (parseFloat(item.QTD_PEDIR) > 0) {
          const row = worksheet.getRow(currentRow);
          row.values = [
            item.REFFORN || item.REFERENCIA,
            item.DESCRPROD,
            parseFloat(item.QTD_PEDIR)
          ];
          
          // Bordas e alinhamento
          row.eachCell((cell, colNumber) => {
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            if (colNumber === 3) cell.alignment = { horizontal: 'center' };
          });
          
          currentRow++;
        }
      });

      // Largura das colunas
      worksheet.getColumn(1).width = 20;
      worksheet.getColumn(2).width = 60;
      worksheet.getColumn(3).width = 15;

      // Gerar e Salvar
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      saveAs(blob, `Pedido_${id_pedido}_${empresaNome.split(' ')[0]}.xlsx`);
    }

    // Logout functionality with SweetAlert2
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Tem certeza?',
        text: "Você será desconectado do sistema.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, sair!',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('logoutForm').submit();
        }
      });
    });
  </script>
</html>
